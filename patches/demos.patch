--- openjdkb18/jdk/src/share/demo/jvmti/gctest/sample.makefile.txt	2007-08-16 03:33:19.000000000 -0400
+++ openjdk/jdk/src/share/demo/jvmti/gctest/sample.makefile.txt	2007-08-23 16:12:59.000000000 -0400
@@ -43,7 +43,7 @@
 
 # Source lists
 LIBNAME=gctest
-SOURCES=gctest.c ../agent_util/agent_util.c
+SOURCES=gctest.c ../../agent_util/src/agent_util.c
 
 # Solaris Sun C Compiler Version 5.5
 ifeq ($(OSNAME), solaris)
@@ -89,7 +89,7 @@
     # Object files needed to create library
     OBJECTS=$(SOURCES:%.c=%.o)
     # Library name and options needed to build it
-    LIBRARY=lib$(LIBNAME).so
+    LIBRARY=../lib/lib$(LIBNAME).so
     LDFLAGS=-Wl,-soname=$(LIBRARY) -static-libgcc -mimpure-text
     # Libraries we are dependent on
     LIBRARIES=-lc
@@ -122,7 +122,7 @@
 
 # Common -I options
 CFLAGS += -I.
-CFLAGS += -I../agent_util
+CFLAGS += -I../../agent_util/src
 CFLAGS += -I$(JDK)/include -I$(JDK)/include/$(OSNAME)
 
 # Default rule
--- openjdkb18/jdk/src/share/demo/jvmti/heapTracker/sample.makefile.txt	2007-08-16 03:33:20.000000000 -0400
+++ openjdk/jdk/src/share/demo/jvmti/heapTracker/sample.makefile.txt	2007-08-24 15:15:40.000000000 -0400
@@ -41,13 +41,15 @@
 #
 ########################################################################
 
+JAVA_CRW_DEMO=../../java_crw_demo/src/libjava_crw_demo.so
+
 # Source lists
 LIBNAME=heapTracker
-SOURCES=heapTracker.c ../agent_util/agent_util.c
+SOURCES=heapTracker.c ../../agent_util/src/agent_util.c
 JAVA_SOURCES=HeapTracker.java
 
 # Name of jar file that needs to be created
-JARFILE=heapTracker.jar
+JARFILE=../heapTracker.jar
 
 # Solaris Sun C Compiler Version 5.5
 ifeq ($(OSNAME), solaris)
@@ -93,10 +95,10 @@
     # Object files needed to create library
     OBJECTS=$(SOURCES:%.c=%.o)
     # Library name and options needed to build it
-    LIBRARY=lib$(LIBNAME).so
+    LIBRARY=../lib/lib$(LIBNAME).so
     LDFLAGS=-Wl,-soname=$(LIBRARY) -static-libgcc -mimpure-text
     # Libraries we are dependent on
-    LIBRARIES=-L $(JDK)/jre/lib/$(LIBARCH) -ljava_crw_demo -lc
+    LIBRARIES=-L../../java_crw_demo/src/ -ljava_crw_demo -lc
     # Building a shared library
     LINK_SHARED=$(LINK.c) -shared -o $@
 endif
@@ -128,15 +130,18 @@
 
 # Common -I options
 CFLAGS += -I.
-CFLAGS += -I../agent_util
-CFLAGS += -I../java_crw_demo
+CFLAGS += -I../../agent_util/src
+CFLAGS += -I../../java_crw_demo/src
 CFLAGS += -I$(JDK)/include -I$(JDK)/include/$(OSNAME)
 
 # Default rule (build both native library and jar file)
 all: $(LIBRARY) $(JARFILE)
 
+$(JAVA_CRW_DEMO):
+	make JDK=$(JDK) OSNAME=$(OSNAME) -C ../../java_crw_demo/src -f sample.makefile.txt
+
 # Build native library
-$(LIBRARY): $(OBJECTS)
+$(LIBRARY): $(OBJECTS) $(JAVA_CRW_DEMO)
 	$(LINK_SHARED) $(OBJECTS) $(LIBRARIES)
 
 # Build jar file
--- openjdkb18/jdk/src/share/demo/jvmti/heapViewer/sample.makefile.txt	2007-08-16 03:33:20.000000000 -0400
+++ openjdk/jdk/src/share/demo/jvmti/heapViewer/sample.makefile.txt	2007-08-23 16:13:00.000000000 -0400
@@ -43,7 +43,7 @@
 
 # Source lists
 LIBNAME=heapViewer
-SOURCES=heapViewer.c ../agent_util/agent_util.c
+SOURCES=heapViewer.c ../../agent_util/src/agent_util.c
 
 # Solaris Sun C Compiler Version 5.5
 ifeq ($(OSNAME), solaris)
@@ -89,7 +89,7 @@
     # Object files needed to create library
     OBJECTS=$(SOURCES:%.c=%.o)
     # Library name and options needed to build it
-    LIBRARY=lib$(LIBNAME).so
+    LIBRARY=../lib/lib$(LIBNAME).so
     LDFLAGS=-Wl,-soname=$(LIBRARY) -static-libgcc -mimpure-text
     # Libraries we are dependent on
     LIBRARIES=-lc
@@ -123,6 +123,7 @@
 # Common -I options
 CFLAGS += -I.
 CFLAGS += -I$(JDK)/include -I$(JDK)/include/$(OSNAME)
+CFLAGS += -I../../agent_util/src
 
 # Default rule
 all: $(LIBRARY)
--- openjdkb18/jdk/src/share/demo/jvmti/hprof/sample.makefile.txt	2007-08-16 03:33:21.000000000 -0400
+++ openjdk/jdk/src/share/demo/jvmti/hprof/sample.makefile.txt	2007-08-23 16:12:58.000000000 -0400
@@ -73,7 +73,7 @@
 JAVA_SOURCES=Tracker.java
 
 # Name of jar file that needs to be created
-#JARFILE=hprof.jar
+JARFILE=../hprof.jar
 
 # Solaris Sun C Compiler Version 5.5
 ifeq ($(OSNAME), solaris)
@@ -110,7 +110,7 @@
 # Linux GNU C Compiler
 ifeq ($(OSNAME), linux)
     # GNU Compiler options needed to build it
-    COMMON_FLAGS=-fno-strict-aliasing -fPIC -fno-omit-frame-pointer
+    COMMON_FLAGS=-fno-strict-aliasing -fPIC -fno-omit-frame-pointer -DSKIP_NPT
     # Options that help find errors
     COMMON_FLAGS+= -W -Wall  -Wno-unused -Wno-parentheses
     # To allow access to dladdr()
@@ -166,7 +166,7 @@
 
 # Common -I options
 CFLAGS += -I.
-CFLAGS += -I../java_crw_demo
+CFLAGS += -I../../java_crw_demo/src
 CFLAGS += -I$(JDK)/include -I$(JDK)/include/$(OSNAME)
 
 # Default rule (build both native library and jar file)
--- openjdkb18/jdk/src/share/demo/jvmti/minst/sample.makefile.txt	2007-08-16 03:33:21.000000000 -0400
+++ openjdk/jdk/src/share/demo/jvmti/minst/sample.makefile.txt	2007-08-24 15:16:17.000000000 -0400
@@ -41,13 +41,15 @@
 #
 ########################################################################
 
+JAVA_CRW_DEMO=../../java_crw_demo/src/libjava_crw_demo.so
+
 # Source lists
 LIBNAME=minst
-SOURCES=minst.c ../agent_util/agent_util.c
+SOURCES=minst.c ../../agent_util/src/agent_util.c
 JAVA_SOURCES=Minst.java
 
 # Name of jar file that needs to be created
-JARFILE=minst.jar
+JARFILE=../minst.jar
 
 # Solaris Sun C Compiler Version 5.5
 ifeq ($(OSNAME), solaris)
@@ -93,10 +95,10 @@
     # Object files needed to create library
     OBJECTS=$(SOURCES:%.c=%.o)
     # Library name and options needed to build it
-    LIBRARY=lib$(LIBNAME).so
+    LIBRARY=../lib/lib$(LIBNAME).so
     LDFLAGS=-Wl,-soname=$(LIBRARY) -static-libgcc -mimpure-text
     # Libraries we are dependent on
-    LIBRARIES=-L $(JDK)/jre/lib/$(LIBARCH) -ljava_crw_demo -lc
+    LIBRARIES=-L../../java_crw_demo/src/ -ljava_crw_demo -lc
     # Building a shared library
     LINK_SHARED=$(LINK.c) -shared -o $@
 endif
@@ -128,15 +130,18 @@
 
 # Common -I options
 CFLAGS += -I.
-CFLAGS += -I../agent_util
-CFLAGS += -I../java_crw_demo
+CFLAGS += -I../../agent_util/src
+CFLAGS += -I../../java_crw_demo/src
 CFLAGS += -I$(JDK)/include -I$(JDK)/include/$(OSNAME)
 
 # Default rule (build both native library and jar file)
 all: $(LIBRARY) $(JARFILE)
 
+$(JAVA_CRW_DEMO):	
+	make JDK=$(JDK) OSNAME=$(OSNAME) -C ../../java_crw_demo/src -f sample.makefile.txt
+
 # Build native library
-$(LIBRARY): $(OBJECTS)
+$(LIBRARY): $(OBJECTS) $(JAVA_CRW_DEMO)
 	$(LINK_SHARED) $(OBJECTS) $(LIBRARIES)
 
 # Build jar file
--- openjdkb18/jdk/src/share/demo/jvmti/mtrace/sample.makefile.txt	2007-08-16 03:33:21.000000000 -0400
+++ openjdk/jdk/src/share/demo/jvmti/mtrace/sample.makefile.txt	2007-08-24 15:16:01.000000000 -0400
@@ -41,13 +41,15 @@
 #
 ########################################################################
 
+JAVA_CRW_DEMO=../../java_crw_demo/src/libjava_crw_demo.so
+
 # Source lists
 LIBNAME=mtrace
-SOURCES=mtrace.c ../agent_util/agent_util.c
+SOURCES=mtrace.c ../../agent_util/src/agent_util.c
 JAVA_SOURCES=Mtrace.java
 
 # Name of jar file that needs to be created
-JARFILE=mtrace.jar
+JARFILE=../mtrace.jar
 
 # Solaris Sun C Compiler Version 5.5
 ifeq ($(OSNAME), solaris)
@@ -93,10 +95,11 @@
     # Object files needed to create library
     OBJECTS=$(SOURCES:%.c=%.o)
     # Library name and options needed to build it
-    LIBRARY=lib$(LIBNAME).so
+    LIBRARY=../lib/lib$(LIBNAME).so
     LDFLAGS=-Wl,-soname=$(LIBRARY) -static-libgcc -mimpure-text
     # Libraries we are dependent on
-    LIBRARIES=-L $(JDK)/jre/lib/$(LIBARCH) -ljava_crw_demo -lc
+    LIBRARIES=-L../../java_crw_demo/src -ljava_crw_demo -lc
+
     # Building a shared library
     LINK_SHARED=$(LINK.c) -shared -o $@
 endif
@@ -128,15 +131,18 @@
 
 # Common -I options
 CFLAGS += -I.
-CFLAGS += -I../agent_util
-CFLAGS += -I../java_crw_demo
+CFLAGS += -I../../agent_util/src
+CFLAGS += -I../../java_crw_demo/src
 CFLAGS += -I$(JDK)/include -I$(JDK)/include/$(OSNAME)
 
 # Default rule (build both native library and jar file)
 all: $(LIBRARY) $(JARFILE)
 
+$(JAVA_CRW_DEMO):
+	make JDK=$(JDK) OSNAME=$(OSNAME) -C ../../java_crw_demo/src -f sample.makefile.txt
+
 # Build native library
-$(LIBRARY): $(OBJECTS)
+$(LIBRARY): $(OBJECTS) $(JAVA_CRW_DEMO)
 	$(LINK_SHARED) $(OBJECTS) $(LIBRARIES)
 
 # Build jar file
--- openjdkb18/jdk/src/share/demo/jvmti/versionCheck/sample.makefile.txt	2007-08-16 03:33:21.000000000 -0400
+++ openjdk/jdk/src/share/demo/jvmti/versionCheck/sample.makefile.txt	2007-08-23 16:12:58.000000000 -0400
@@ -43,7 +43,7 @@
 
 # Source lists
 LIBNAME=versionCheck
-SOURCES=versionCheck.c ../agent_util/agent_util.c
+SOURCES=versionCheck.c ../../agent_util/src/agent_util.c
 
 # Solaris Sun C Compiler Version 5.5
 ifeq ($(OSNAME), solaris)
@@ -89,7 +89,7 @@
     # Object files needed to create library
     OBJECTS=$(SOURCES:%.c=%.o)
     # Library name and options needed to build it
-    LIBRARY=lib$(LIBNAME).so
+    LIBRARY=../lib/lib$(LIBNAME).so
     LDFLAGS=-Wl,-soname=$(LIBRARY) -static-libgcc -mimpure-text
     # Libraries we are dependent on
     LIBRARIES=-lc
@@ -122,7 +122,7 @@
 
 # Common -I options
 CFLAGS += -I.
-CFLAGS += -I../agent_util
+CFLAGS += -I../../agent_util/src
 CFLAGS += -I$(JDK)/include -I$(JDK)/include/$(OSNAME)
 
 # Default rule
--- openjdkb18/jdk/src/share/demo/jvmti/waiters/sample.makefile.txt	2007-08-16 03:33:21.000000000 -0400
+++ openjdk/jdk/src/share/demo/jvmti/waiters/sample.makefile.txt	2007-08-23 16:13:06.000000000 -0400
@@ -43,7 +43,7 @@
 
 # Source lists
 LIBNAME=waiters
-SOURCES=waiters.cpp Agent.cpp Thread.cpp Monitor.cpp ../agent_util/agent_util.c
+SOURCES=waiters.cpp Agent.cpp Thread.cpp Monitor.cpp
 
 # Solaris Sun C Compiler Version 5.5
 ifeq ($(OSNAME), solaris)
@@ -89,9 +89,10 @@
     endif
     # Object files needed to create library
     OBJECTS=$(SOURCES:%.cpp=%.o)
+    OBJECTS+=../../agent_util/src/agent_util.o
     # Library name and options needed to build it
-    LIBRARY=lib$(LIBNAME).so
-    LDFLAGS=-Wl,-soname=$(LIBRARY) -static-libgcc -mimpure-text
+    LIBRARY=../lib/lib$(LIBNAME).so
+    LDFLAGS=-Wl,-soname=$(LIBRARY) -static-libgcc
     # Libraries we are dependent on
     LIBRARIES=
     # Building a shared library
@@ -123,9 +124,10 @@
 
 # Common -I options
 CXXFLAGS += -I.
-CXXFLAGS += -I../agent_util
+CXXFLAGS += -I../../agent_util/src
 CXXFLAGS += -I$(JDK)/include -I$(JDK)/include/$(OSNAME)
 
+CFLAGS = $(CXXFLAGS)
 # Default rule
 all: $(LIBRARY)
 
